---
title: Figure 2
jupyter:
  jupytext:
    formats: 'ipynb,qmd'
    text_representation:
      extension: .qmd
      format_name: quarto
      format_version: '1.0'
      jupytext_version: 1.16.1
  kernelspec:
    display_name: R 4.4
    language: R
    name: ir44
---


# Setup
```{r}
setwd("/project/kohl_analysis/analysis/CAdir/results/results/")
renv::load("/project/kohl_analysis/analysis/CAdir")
devtools::load_all("/home/kohl/PhD/gits/ClemensKohl/CAdir")
source("./utils.R")

suppressPackageStartupMessages({
  library(APL)
  library(SingleCellExperiment)
  library(dplyr)
  library(tidyr)

  # To load the data set
  library(TENxPBMCData)
  library(Seurat)
  library(SeuratObject)
  library(scater)
  library(scuttle)
  library(scran)
})

dir <- "/project/kohl_analysis/analysis/CAdir/results/results/"
imgdir <- file.path(dir, "img/figure2/")
dir.create(imgdir, recursive = TRUE)

options(repr.plot.width = 20, repr.plot.height = 15)
```

## Load data

```{r}
sce <- sce_pbmc3k()
```

# CAdir

```{r}
set.seed(1234)

sce_bu <- sce
sce.dec <- scran::modelGeneVar(sce)
sce.top <- scran::getTopHVGs(sce.dec, prop = 0.2, var.threshold = NULL)
sce <- sce[sce.top, ]
sce <- runUMAP(sce, ntop = 2000)

ca <- cacomp(
    obj = as.matrix(logcounts(sce)),
    princ_coords = 3,
    dims = 30,
    top = nrow(sce),
    residuals = "pearson",
    python = TRUE,
    clip = TRUE
)
```

With `cutoff = NULL` CAdir tries to estimate the angle cutoff directly from the data.

## Split & Merge Clustering
```{r}
set.seed(2358)
cak <- dirclust_splitmerge(
    caobj = ca,
    k = 15,
    cutoff = NULL,
    method = "random",
    apl_quant = 0.99,
    counts = NULL,
    min_cells = 30,
    reps = 5,
    make_plots = TRUE,
    apl_cutoff_reps = 100,
    qcutoff = 0.1
)

cadir <- rank_genes(cadir = cak, caobj = ca)
top <- top_genes(cadir)
```

### Annotate clusters
```{r}
cak <- annotate_biclustering(
    obj = cak,
    universe = rownames(sce),
    org = "hs"
)

cak <- rank_genes(cadir = cak, caobj = ca)
cak

sce$cadir <- cak@cell_clusters

um1 <- plotUMAP(sce, colour = "cadir")
um2 <- plotUMAP(sce, colour = "cell_type")

ari <- aricode::clustComp(sce$cadir, sce$cell_type)
p <- um1 + ggtitle(paste0("ARI: ", round(ari$ARI, 2))) + um2
p

ggsave(
  plot = p,
  file = file.path(imgdir, "umap.png"),
  width = 3600,
  height = 1800,
  units = "px"
)

```

## Association plots of clusters
```{r}
pc <- plot_clusters(
  cak,
  ca,
  show_genes=T,
  label_genes = T,
  ntop = 5
)

ggsave(
  plot = pc,
  file = file.path(imgdir, "plot_clusters.pdf"),
  width = 3400,
  height = 2000,
  units ="px"
)
```

### Angle between clusters - **TO DELETE**
```{r}
ang_rad <- get_angle(cak@directions, cak@directions) 
ang_deg <- as.data.frame(rad2deg(ang_rad)) %>% tibble::rownames_to_column("cluster")

long_ang <- tidyr::pivot_longer(data = ang_deg, cols = -cluster, values_to = "angle", names_to = "to_cluster" )

p <- ggplot(long_ang, aes(x=cluster, y = to_cluster, fill = angle)) +
  geom_tile() +
  viridis::scale_fill_viridis() +
  theme_bw()+
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

p
```

```{r}
idx <- base::which(cak@cell_clusters == "cluster_5")

tmp = colData(sce)
tmp$coi <- "others"
tmp$coi[idx] <- "coi"
tmp$coi <- sort(tmp$coi, decreasing = TRUE)
ggplot(tmp, aes(x = nCount_RNA, y = nFeature_RNA, color = coi )) +
  geom_point()

ggplot(tmp, aes(x = cell_type, y = percent.mt, color = coi )) +
  geom_point()

devtools::load_all("~/gits/ClemensKohl/RUtils/")
plot_hm(
  sce = sce,
  cell_clusters = cak@cell_clusters,
  gene_clusters = cak@gene_clusters,
  show_column_title = character(0),
  show_row_title = character(0),
  row_title_rot = 90,
  show_row_names = FALSE
  )

```



## Split & Merge plot
```{r}
sm <- sm_plot(
  cadir = cak,
  caobj = ca,
  rm_redund = TRUE,
  keep_end = TRUE,
  highlight_cluster = TRUE,
  show_genes = F,
  annotate_clusters = TRUE,
  org = "hs"
)
sm

ggsave(plot = sm,
  file = file.path(imgdir, "split_merge_plot.pdf"),
  width = 3000,
  height = 1800,
  units = "px")
```




```{r}
sessionInfo()
```


